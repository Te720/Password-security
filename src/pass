#! /bin/bash

check() {
    grep "$(basename "$0"):" /etc/.raulm/.Ye/ | cut -d : -f 2 | openssl enc -d -des -md md5 -a -pbkdf2 -out /etc/.raulm/.Ye/Th_6K.dec -k /var/.tracer >/dev/null
    if [ "${pass}" != "$(cat /etc/.raulm/.Ye/Th_6K.dec)" ]; then
        echo -e "\n\e[1;31mWrong"
        rm /etc/.raulm/.Ye/Th_6K.dec
        exit
    fi
    rm /etc/.raulm/.Ye/Th_6K.dec
}

if [ "$(basename "$0")" = "pass" ] && [ -z "$1" ]; then
    echo -e "\e[1mUsage:\e[0m pass [argument][file1][file2]...\n\nNo argument:\t\t\tSecure files or one file by password\n-r --remove:\t\t\t\tRemove security password from files\npass 'none':\t\t\t\tshow this help message\n\n\e[1mFor secured files:\nUsage:\e[0m [file][argument]\n\n-c --change:\t\t\t\tChange password\nNone:\t\t\t\tstart file with password\n\n\e[1me.g:\e[0m -c argument will not work in secured file so try to change it or use another one"
elif [ "$(basename "$0")" != "pass" ] && [[ "$1" = !(-c|--change) ]]; then
    read -rsp "Enter password: " pass
    check
elif [ "$(basename "$0")" != "pass" ] && [[ "$1" =~ ^(-c|--change) ]]; then
    read -rsp "Enter current password: " pass
    check
    sed -i "/$(basename "$0"):/d" /etc/.raulm/.Ye/Th_6K
    if trap '' SIGINT; then
        echo
        read -rsp "Change password: " pass
    fi
    echo "$(basename "$0"):$(echo "${pass}" | openssl enc -des -md md5 -a -pbkdf2 -k /var/.tracer)" | tee -a /etc/.raulm/.Ye/Th_6K >/dev/null
    echo -e "\n\e[1;32mpassword successfully updated"
    exit
elif [ "$(basename "$0")" = "pass" ] && [[ "$1" =~ ^(-r|--remove) ]]; then
    for arv in "${@:2}"; do
        chmod a+w "${arv}"
        if [[ "${arv}" =~ ^(-[a-z]|-[A-Z]|-[0-9]|--[a-z]|--[A-Z]|--[0-9]) ]]; then
            echo -e "\e[1mUnknown argument ${arv}\e[0m\n"
        elif [ ! -e "${arv}" ]; then
            echo -e "\e[1mUnfound\e[1m\n"
        elif ! grep "source pass" "${arv}" >/dev/null; then
            echo -e "\e[1m$(basename "${arv}") already not secured\e[0m\n"
            chmod a-w "${arv}"
        elif grep "source pass" "${arv}" >/dev/null; then
            read -rsp "Enter $(basename "${arv}") password: " pass
            echo
            grep "$(basename "${arv}"):" /etc/.raulm/.Ye | cut -d : -f 2 | openssl enc -d -des -md md5 -a -pbkdf2 -out /etc/.raulm/.Ye/.dec -k /var/.tracer >/dev/null
            if [ "${pass}" != "$(cat /etc/.raulm/.Ye/.dec)" ]; then
                echo -e "\e[1;31mWrong"
                rm /etc/.raulm/.Ye/.dec
                chmod a-w "${arv}"
                exit
            fi
            rm /etc/.raulm/.Ye/.dec
            sed -i "2,4d" "${arv}"
            sed -i "/$(basename "${arv}"):/d" /etc/.raulm/.Ye/
            chmod go+rwx "${arv}"
            chmod a+w "${arv}"
            echo -e "\e[1;33m$(basename "${arv}") security desabled\e[\n0m\n"
            if [ ! -s /etc/.raulm/.Ye/ ]; then
                rm /etc/.raulm/.Ye/
            fi
        fi
    done
elif [ "$(basename "$0")" = "pass" ]; then
    for arg in "$@"; do
        chmod a+w "${arg}"
        if [[ "${arg}" =~ ^(-[a-z]|-[A-Z]|-[0-9]|--[a-z]|--[A-Z]|--[0-9]) ]]; then
            echo -e "\e[1mUnknown argument ${arv}\e[0m\n"
        elif [ ! -e "${arg}" ]; then
            echo -e "\e[1mUnfound\e[1m\n"
        elif grep "source pass" "${arg}" >/dev/null; then
            echo -e "\e[1m$(basename "${arg}") already secured\e[0m\n"
            chmod a-w "${arg}"
        elif ! grep "source pass" "${arg}" >/dev/null; then
            sed -i "2i\ \n# shellcheck source=/dev/null\nsource pass" "${arg}"
            if trap '' SIGINT; then
                read -rsp "Creat $(basename "${arg}") password: " pass
                echo
            fi
            echo "$(basename "${arg}"):$(echo "${pass}" | openssl enc -des -md md5 -a -pbkdf2 -k /var/.tracer)" | tee -a /etc/.raulm/.Ye/ >/dev/null
            chmod go-rwx "${arg}"
            chmod a-w "${arg}"
            echo -e "\e[1;32m$(basename "${arg}") password successfully created\e[\n0m\n"
        fi
    done
fi
